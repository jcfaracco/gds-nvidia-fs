# SPDX-License-Identifier: GPL-2.0
# NVFS Test Suite Makefile

# Kernel build variables
KDIR ?= /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

# Include subdirectories
obj-y += kunit/
obj-y += legacy/

# Default targets
all: kunit legacy

# Build KUnit tests
kunit:
	@echo "Building KUnit tests..."
	$(MAKE) -C $(KDIR) M=$(PWD)/kunit modules

# Build legacy self-tests  
legacy:
	@echo "Building legacy self-tests..."
	$(MAKE) -C $(PWD)/legacy

# Clean all build artifacts
clean:
	@echo "Cleaning KUnit tests..."
	$(MAKE) -C $(KDIR) M=$(PWD)/kunit clean
	@echo "Cleaning legacy tests..."
	$(MAKE) -C $(PWD)/legacy clean
	rm -f *.o *.ko *.mod.c *.mod *.order *.symvers

# Run KUnit tests
test-kunit:
	@echo "Running KUnit tests..."
	@echo "Use: kunit.py run --kunitconfig=src/tests/kunit/"
	@echo "Or build with CONFIG_NVFS_KUNIT_TEST=y and boot kernel"

# Run legacy tests
test-legacy:
	@echo "Running legacy self-tests..."
	$(MAKE) -C $(PWD)/legacy test

# Install all test modules
install: kunit legacy
	@echo "Installing KUnit test modules..."
	find kunit/ -name "*.ko" -exec sudo insmod {} \; || true
	@echo "Installing legacy test modules..."
	$(MAKE) -C $(PWD)/legacy install

# Uninstall all test modules
uninstall:
	@echo "Uninstalling test modules..."
	sudo rmmod nvfs_core_kunit || true
	sudo rmmod nvfs_stress_kunit || true
	$(MAKE) -C $(PWD)/legacy uninstall || true

# Show help
help:
	@echo "NVFS Test Suite Makefile"
	@echo ""
	@echo "Test Types:"
	@echo "  KUnit Tests    - Modern kernel unit testing framework"
	@echo "  Legacy Tests   - Original debugfs-based self-tests"
	@echo ""
	@echo "Targets:"
	@echo "  all           - Build all tests (KUnit + legacy)"
	@echo "  kunit         - Build KUnit tests only"
	@echo "  legacy        - Build legacy tests only"
	@echo "  clean         - Clean all build artifacts"
	@echo "  test-kunit    - Run KUnit tests"
	@echo "  test-legacy   - Run legacy tests"
	@echo "  install       - Install all test modules"
	@echo "  uninstall     - Uninstall all test modules"
	@echo "  help          - Show this help"
	@echo ""
	@echo "KUnit Test Usage:"
	@echo "  # Build kernel with tests"
	@echo "  CONFIG_NVFS_KUNIT_TEST=y"
	@echo "  CONFIG_NVFS_KUNIT_TEST_CORE=y"
	@echo "  CONFIG_NVFS_KUNIT_TEST_STRESS=y"
	@echo ""
	@echo "  # Run with kunit tool"
	@echo "  kunit.py run --kunitconfig=src/tests/kunit/"
	@echo ""
	@echo "Legacy Test Usage:"
	@echo "  make test-legacy"
	@echo "  echo 'all' > /sys/kernel/debug/nvfs_test/run_tests"

.PHONY: all kunit legacy clean test-kunit test-legacy install uninstall help